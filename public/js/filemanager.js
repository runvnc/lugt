// Generated by CoffeeScript 1.4.0
(function() {
  var copySelected, cutSelected, cwd, deleteSelected, getlink, listFiles, pasteFiles, selfiles, selop, shiftSel, showFiles, sortem;

  cwd = '.';

  sortem = function(files) {
    files.sort(function(a, b) {
      if (a.isDirectory) {
        return -1;
      } else {
        if (a.name < b.name) {
          return -1;
        } else if (a.name === b.name) {
          return 0;
        } else {
          return 1;
        }
      }
    });
    return files;
  };

  deleteSelected = function() {
    var todel;
    todel = [];
    $('.fmselected').each(function() {
      return todel.push($(this).text());
    });
    if (confirm("Delete " + todel.length + " files/directories??")) {
      return now.deleteFiles(todel, cwd, function() {
        return listFiles();
      });
    }
  };

  selfiles = [];

  selop = '';

  copySelected = function() {
    selfiles = [];
    selop = 'copy';
    $('.fmselected').each(function() {
      var dir;
      if (cwd === '.') {
        dir = '';
      } else {
        dir = cwd;
      }
      return selfiles.push(cwd + $(this).text());
    });
    $('#copysel').text('Copy Selected (' + selfiles.length + ')');
    console.log('copy files: ');
    return console.log(selfiles);
  };

  cutSelected = function() {
    selfiles = [];
    selop = 'cut';
    $('.fmselected').each(function() {
      var dir;
      if (cwd === '.') {
        dir = '';
      } else {
        dir = cwd;
      }
      return selfiles.push(dir + $(this).text());
    });
    $('#cutsel').text('Cut Selected (' + selfiles.length + ')');
    console.log('cut files: ');
    return console.log(selfiles);
  };

  pasteFiles = function() {
    console.log('pastefiles client');
    if (selop === 'copy') {
      console.log('calling nowcopyfiles');
      return now.copyFiles(selfiles, cwd, function() {
        listFiles();
        return $('#copysel').text('Copy Selected');
      });
    } else if (selop === 'cut') {
      console.log('calling nowmovefiles');
      return now.moveFiles(selfiles, cwd, function() {
        listFiles();
        return $('#cutsel').text('Cut Selected');
      });
    }
  };

  shiftSel = function(e, th) {
    var clickedIndex, i, max, min, selIndex, _i, _results;
    selIndex = $('.fmselected').index();
    clickedIndex = $(th).index();
    min = Math.min(selIndex, clickedIndex);
    max = Math.max(selIndex, clickedIndex);
    $('.fmselected').each(function() {
      min = Math.min(min, $(this).index());
      return max = Math.max(max, $(this).index());
    });
    $('.fmitem').removeClass('fmselected');
    _results = [];
    for (i = _i = min; min <= max ? _i <= max : _i >= max; i = min <= max ? ++_i : --_i) {
      _results.push($("#fsroot li:eq(" + i + ")").addClass('fmselected'));
    }
    return _results;
  };

  showFiles = function(files) {
    var classnm, file, listing, str, _i, _len;
    console.log('**** FileManager showFiles ****');
    str = '<li class=\"fmitem fmupdir\">..</li>';
    sortem(files);
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      listing = file.name;
      classnm = "fmfile";
      if (file.isDirectory) {
        listing += '/';
        classnm = "fmdir";
      }
      str += "<li class=\"fmitem " + classnm + "\">" + listing + "</li>";
    }
    $('#fsroot').html(str);
    $('.fmdir').off('dblclick');
    $('.fmdir').on('dblclick', function() {
      if (cwd === '.') {
        cwd = './';
      }
      cwd += $(this).text();
      return listFiles();
    });
    $('.fmupdir').off('dblclick');
    $('.fmupdir').on('dblclick', function() {
      var d, dirs, newdirs, _j, _len1;
      dirs = cwd.split('/');
      newdirs = [];
      for (_j = 0, _len1 = dirs.length; _j < _len1; _j++) {
        d = dirs[_j];
        if (d !== '') {
          newdirs.push(d);
        }
      }
      newdirs.splice(newdirs.length - 1, 1);
      cwd = newdirs.join('/');
      cwd = cwd + '/';
      return listFiles();
    });
    $('.fmitem').off('click');
    $('.fmitem').on('click', function(e) {
      if (e.ctrlKey) {
        return $(this).addClass('fmselected');
      } else if (e.shiftKey) {
        return shiftSel(e, this);
      } else {
        $('.fmitem').removeClass('fmselected');
        return $(this).addClass('fmselected');
      }
    });
    $('#deletesel').off('click');
    $('#deletesel').on('click', deleteSelected);
    $('#copysel').off('click');
    $('#copysel').on('click', copySelected);
    $('#cutsel').off('click');
    $('#cutsel').on('click', cutSelected);
    $('#pastefiles').off('click');
    return $('#pastefiles').on('click', pasteFiles);
  };

  listFiles = function() {
    return now.listFiles(cwd, function(files) {
      return showFiles(files);
    });
  };

  getlink = function() {
    var url;
    url = $('#loadfromurl').val();
    return now.loadAndUncompress(url, cwd, function(err) {
      $('#loadfromurl').val('');
      return listFiles();
    });
  };

  window.doneUploading = function() {
    $('#fileman iframe').attr('src', '/dyn/upframe');
    return listFiles();
  };

  $(function() {
    $('#advobjs').prepend('<button title="File manager" id=\"openfm\" class=\"white button\"><img src=\"images/folder.png\"/></button>');
    $('#openfm').click(function() {
      $('#fileman').dialog({
        title: 'File Manager',
        width: 870,
        height: $(window).height() * .9
      });
      $('#upframe').show();
      $('#fileswin').height($(window).height() * .75);
      return listFiles();
    });
    $('#refreshdir').click(listFiles);
    return $('#getlink').click(getlink);
  });

}).call(this);

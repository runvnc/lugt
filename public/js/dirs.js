// Generated by CoffeeScript 1.4.0
(function() {
  var cwd, getlink, listFiles, showFiles, sortem;

  cwd = '.';

  sortem = function(files) {
    files.sort(function(a, b) {
      if (a.isDirectory) {
        return -1;
      } else {
        if (a.name < b.name) {
          return -1;
        } else if (a.name === b.name) {
          return 0;
        } else {
          return 1;
        }
      }
    });
    return files;
  };

  listFiles = function() {
    return now.listFiles(cwd, function(files) {
      return showFiles(files);
    });
  };

  getlink = function() {
    var url;
    url = $('#loadfromurl').val();
    return now.loadAndUncompress(url, cwd, function(err) {
      $('#loadfromurl').val('');
      return listFiles();
    });
  };

  showFiles = function(files) {
    var classnm, file, listing, str, _i, _len;
    console.log('**** FileManager showFiles ****');
    str = '<li class=\"fmitem fmupdir\">..</li>';
    sortem(files);
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      listing = file.name;
      classnm = "fmfile";
      if (file.isDirectory) {
        listing += '/';
        classnm = "fmdir";
        str += "<li class=\"fmitem " + classnm + "\">" + listing + "</li>";
      }
    }
    $('#fsroot').html(str);
    $('.fmdir').off('click');
    $('.fmdir').on('click', function() {
      if (cwd === '.') {
        cwd = './';
      }
      cwd += $(this).text();
      return listFiles();
    });
    $('.fmupdir').off('click');
    return $('.fmupdir').on('click', function() {
      var d, dirs, newdirs, _j, _len1;
      dirs = cwd.split('/');
      newdirs = [];
      for (_j = 0, _len1 = dirs.length; _j < _len1; _j++) {
        d = dirs[_j];
        if (d !== '') {
          newdirs.push(d);
        }
      }
      newdirs.splice(newdirs.length - 1, 1);
      cwd = newdirs.join('/');
      cwd = cwd + '/';
      return listFiles();
    });
  };

  $(function() {
    return $('#seldir').click(function() {
      $('#fileman').dialog({
        title: 'Select Directory',
        width: 870,
        height: $(window).height() * .9
      });
      $('#upframe').show();
      $('#fileswin').height($(window).height() * .75);
      listFiles();
      return $('#refreshdir').click(listFiles);
    });
  });

}).call(this);
